#!/bin/bash

NAME=glibc
PROGRAM=$NAME-$glibc_VER
FILE=$NAME-$glibc_VER$glibc_PRIP

source $SCRIPTS_DIR/include/unpack_sep_bzip

echo -e "$Y Spoustim Build $DEF"

cd $BUILD_DIR/$PROGRAM

{
	echo -e "$C Aplikuji patch $DEF"
	echo -e "$G patch -Np1 -i $SOURCES_DIR/glibc-2.12.1-gcc_fix-1.patch $DEF"
	patch -Np1 -i $SOURCES_DIR/glibc-2.12.1-gcc_fix-1.patch

	echo -e "$C Aplikuji patch $DEF"
	echo -e "$G patch -Np1 -i $SOURCES_DIR/glibc-2.12.1-makefile_fix-1.patch $DEF"
	patch -Np1 -i $SOURCES_DIR/glibc-2.12.1-makefile_fix-1.patch

cd $BUILD_DIR/$PROGRAM-BUILD

	echo -e "$C Nastavuji CFLAGS pro x86 $DEF"
echo "CFLAGS += -march=i486 -mtune=native" > configparms



	echo -e "$G ../$PROGRAM/configure $DEF" 
    ../$PROGRAM/configure --prefix=/tools --host=$LFS_TGT --build=$(../glibc-2.12.1/scripts/config.guess) --disable-profile --enable-add-ons --enable-kernel=2.6.22.5 --with-headers=/tools/include libc_cv_forced_unwind=yes libc_cv_c_cleanup=yes

	if [ $? -ne 0 ]
		then
			echo -e "$R Configure selhalo $DEF"
			exit 1
	fi
    echo -e "$G make $DEF"
    make
	if [ $? -ne 0 ]
		then
			echo -e "$R make selhalo $DEF"
			exit 1
	fi
    echo -e "$G make-install $DEF"
    make install
	if [ $? -ne 0 ]
		then
			echo -e "$R make install selhalo $DEF"
			exit 1
	fi
} 2>&1 | tee $BUILD_DIR/LOG_$PROGRAM.log
if [ $PIPESTATUS -ne 0 ]
	then
		echo -e "$R build selhal $DEF"
		exit 1
fi  
if [ $BUILD_RM == 1 ];
	then
                echo -e "$C Mazu slozku s buildem $DEF"
                echo -e "$G rm -rf $BUILD_DIR/$PROGRAM-BUILD $DEF"
                rm -rf $BUILD_DIR/$PROGRAM-BUILD
                echo -e "$C Mazu slozku se zdrojaky $DEF"
                echo -e "$G rm -rf $BUILD_DIR/$PROGRAM $DEF"
                rm -rf $BUILD_DIR/$PROGRAM
	else
		echo -e "$C Slozka s buildem a zdrojaky ponechana $DEF"
fi
cd $ROOT
